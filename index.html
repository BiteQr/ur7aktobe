<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Оставьте отзыв</title>
<style>
/* стили оставляем как в твоем предыдущем коде */
body { font-family: Arial; background: linear-gradient(135deg, #74ebd5, #ACB6E5); display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
.container { background: rgba(255,255,255,0.95); padding: 30px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); text-align:center; width:90%; max-width:350px; position:absolute; opacity:0; transform:scale(0.95); transition: all 0.4s ease; pointer-events:none; }
.container.active { opacity:1; transform:scale(1); pointer-events:all; }
select, button { padding:12px 20px; margin:15px 0; font-size:16px; width:100%; border-radius:8px; border:1px solid #ccc; transition:all 0.2s ease; }
button { cursor:pointer; background:#6a11cb; color:#fff; border:none; }
button:hover { background:#2575fc; transform: scale(1.05); box-shadow:0 5px 15px rgba(0,0,0,0.2);}
.star { font-size:30px; cursor:pointer; color:#ccc; margin:0 5px; transition:all 0.2s ease; display:inline-block;}
.star:hover, .star.hovered { color: gold; transform: translateY(-5px) scale(1.2);}
img#empPreview { margin-top:10px; width:60px; height:60px; border-radius:50%;}
.spinner { border:4px solid #f3f3f3; border-top:4px solid #6a11cb; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; display:none; margin-left:10px;}
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.checkmark { color:green; font-size:24px; margin-left:10px; display:inline-block; opacity:0; transition: opacity 0.5s;}
</style>
</head>
<body>

<div class="container active" id="step1">
  <h1>Выберите сотрудника</h1>
  <select id="employee"><option value="">-- Выберите --</option></select>
  <img id="empPreview" src="" alt="">
  <button id="next1">Далее</button>
</div>

<div class="container" id="step2">
  <h1>Оцените сотрудника</h1>
  <div id="stars">
    <span class="star" data-value="1">★</span>
    <span class="star" data-value="2">★</span>
    <span class="star" data-value="3">★</span>
    <span class="star" data-value="4">★</span>
    <span class="star" data-value="5">★</span>
  </div>
  <button id="next2">Далее</button>
</div>

<div class="container" id="step3">
  <h1>Откуда вы узнали о нас?</h1>
  <select id="source">
    <option value="">-- Выберите --</option>
    <option value="Instagram">Instagram</option>
    <option value="Facebook">Facebook</option>
    <option value="Друзья">Друзья</option>
    <option value="Другое">Другое</option>
  </select>
  <button id="send">Отправить отзыв</button>
  <span class="spinner" id="spinner"></span>
  <span class="checkmark" id="checkmark">✓</span>
</div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbzjcF_M21MaEGYXi7JjYyHAihyWfKK9NUeWPFhaGlWslu5WsDjgTxd4WBU_fL_N03-b/exec"; // Вставь сюда URL твоего Apps Script

let rating = 0;
const select = document.getElementById('employee');

// Подгружаем сотрудников из Google Sheets
fetch(webAppUrl)
  .then(res => res.json())
  .then(employees=>{
    employees.forEach(emp=>{
      const option = document.createElement('option');
      option.value = emp.employee_name;
      option.textContent = emp.employee_name;
      option.dataset.id = emp.employee_id;
      option.dataset.img = emp.img_url;
      select.appendChild(option);
    });
  });

select.addEventListener('change', ()=>{
  const selected = select.selectedOptions[0];
  const img = selected.dataset.img || "";
  document.getElementById('empPreview').src = img;
});

function showStep(stepId){
  document.querySelectorAll('.container').forEach(c=>c.classList.remove('active'));
  document.getElementById(stepId).classList.add('active');
}

document.getElementById('next1').addEventListener('click', ()=>{
  const emp = select.value;
  if(!emp){ alert('Выберите сотрудника'); return; }
  localStorage.setItem('employee', emp);
  localStorage.setItem('employee_id', select.selectedOptions[0].dataset.id);
  showStep('step2');
});

document.querySelectorAll('.star').forEach(star=>{
  star.addEventListener('mouseover', ()=>{
    document.querySelectorAll('.star').forEach(s=>s.classList.toggle('hovered', s.dataset.value <= star.dataset.value));
  });
  star.addEventListener('mouseout', ()=>{
    document.querySelectorAll('.star').forEach(s=>s.classList.remove('hovered'));
  });
  star.addEventListener('click', ()=>{
    rating = star.dataset.value;
    document.querySelectorAll('.star').forEach(s=>s.style.color = s.dataset.value <= rating ? 'gold' : '#ccc');
  });
});

document.getElementById('next2').addEventListener('click', ()=>{
  if(!rating){ alert('Поставьте оценку'); return; }
  localStorage.setItem('rating', rating);
  showStep('step3');
});

document.getElementById('send').addEventListener('click', ()=>{
  const source = document.getElementById('source').value;
  if(!source){ alert('Выберите источник'); return; }
  const spinner = document.getElementById('spinner');
  const checkmark = document.getElementById('checkmark');
  spinner.style.display='inline-block';
  checkmark.style.opacity=0;

  const data = {
    employee_id: localStorage.getItem('employee_id'),
    employee_name: localStorage.getItem('employee'),
    rating: localStorage.getItem('rating'),
    known_before: "", // при необходимости добавьте второй вопрос
    visit_reason: source
  };

  fetch(webAppUrl,{
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  }).finally(()=>{
    spinner.style.display='none';
    checkmark.style.opacity=1;
    setTimeout(()=>{
      checkmark.style.opacity=0;
      localStorage.clear();
      showStep('step1');
    },1500);
  });
});
</script>
</body>
</html>
